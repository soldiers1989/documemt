# 支付宝支付

## 【上门美妆】支付宝APP支付
1. 用户下单
    前端APP将用户订单信息（作品id、时间、地点、手机号）发送给后端，后端校验并锁定预约时间，记录订单详情到reservation表，通知化妆师接单。2分钟内通知运营人员。  
    注：
    - 促销商品的价格与订单价格可能不一致。
    - 促销商品生成的订单，依然可以使用优惠券进行支付。
2. 生成预支付订单
    用户点击支付，后端根据reservation表中的订单详情，向pay_record表插入一条预支付记录，向pay_record_detail表插入一条支付记录详情。如果支付时使用了优惠券，则pay_record_detail表中还会插入一条优惠券的支付记录。  
    注：
    - 如果使用优惠券已经能够完全支付本次订单，则pay_record_detail表只会插入一条优惠券的支付记录。并且，返回给前端的数据中order_status=2，表示已经支付完成。
    - 每次生成预支付信息，都会生成一个全局唯一的交易编号bill id。支付宝同步通知和异步通知中会持有该交易编号通知用户交易完成。
    - 用户支付失败或者取消支付时，前端APP会立刻通知后台，删除本次预支付记录（pay_record表和pay_record_detail表中的记录）
3. 调起支付界面
    南瓜姑娘APP将后端返回的预支付信息，构造支付请求（请求中包含异步通知地址notify_url），并发送给支付宝APP，用户确认、输入密码，支付宝APP完成支付后，同步返回给南瓜姑娘APP支付结果，且支付宝服务器向南瓜姑娘后台服务器发送异步通知。  
    - 功能流程  
    ![功能流程图](http://photosd.nggirl.com.cn/work/cc3793cd8bd84d3db8034fcaea544bad.png)

    - 数据交互  
    ![数据交互图](http://photosd.nggirl.com.cn/work/db2e876390dd415c9fd111220595d672.png)
4. APP同步通知
    用户支付完成后，支付宝APP同步返回支付结果（成功、失败、用户取消），南瓜姑娘APP进行刷新页面和页面跳转等工作。  
    注：
    - 同步通知的结果，并不作为交易成功的依据，异步通知的结果是真实有效依据。
    - 同步通知和异步通知之间有一定的时间间隔，所以可能会出现，用户已支付，但是后台记录的依然是未支付状态的情况。
5. 服务器异步通知
    用户支付完成后，支付宝服务器向南瓜姑娘服务器指定地址notify_url发送异步通知，后台根据通知中的交易编号bill id，确定订单信息，更新订单记录reservation、pay_record、pay_record_detail等。
6. 支付失败
    用户支付失败（凡是没有支付成功的情况都算失败）后，前端APP需要调用接口，立即通知后台删除本次支付记录。

## 【上门美妆】支付宝WEB支付
1. 用户下单，同支付宝APP支付
2. 生成预支付订单，同支付宝APP支付
3. 调起支付界面
  WEB支付的界面是H5页面，所以，在生成预支付订单后，H5前端需要根据订单支付状况（未处理出错、未支付完成的订单），跳转到南瓜姑娘服务器提供的H5页面，进行支付。在该h5页面内部会组装请求数据（包含同步跳转地址return_url和异步通知地址notify_url以及支付失败时的跳转地址show_url），构造form表单，提交到支付宝指定的地址，拉起支付宝WEB支付页面
    - 支付宝WEB支付页面  
        ![支付宝WEB支付页面截图](http://photosd.nggirl.com.cn/work/80b43799d07642c28b1adde9ed50f1f6.png)

    - 点击确认、输入密码、完成后，进入同步通知地址return_url，支付宝服务器向南瓜姑娘服务器notify_url发送异步通知请求；用户点击“返回”按钮，将取消支付，支付宝会同步跳转到支付失败地址show_url
4. WEB同步通知页面
    该同步通知地址由请求参数中的return_url指定，在用户支付成功后，支付宝跳转到该地址，并携带支付相关参数。
    注：请求参数中的return_url并非是用户看到的地址，后台在支付宝同步返回时会查询数据库，进行一定的逻辑判断，用户看到的地址是后台重定向后的页面。
5. 服务器异步通知
    同APP异步通知
6. 支付失败通知
    用户支付失败后会跳转到show_url指定的地址。
    注：目前上门美妆的支付失败通知地址是订单详情页面。即，每当订单支付失败时，则刷新订单详情页面。

## 【美妆沙龙】支付宝APP支付和WEB支付
美妆沙龙与上门美妆的重要区别是，美妆沙龙的下单和和支付是在同一个动作完成的。美妆沙龙的下单和生成预支付订单，在同一个接口中完成。每次用户点击“确认并支付”按钮，后台同时进行下单和生成预支付订单，如果用户失败，则需要重新下单。
美妆沙龙与上门美妆其他的支付过程类似：
  - 都需要生成订单和预支付订单
  - 同时有同步通知和异步通知，数据格式相同
  - WEB支付失败时都有失败通知，APP支付失败时，都需要删除预支付记录
  注：美妆沙龙的WEB支付失败页面是下单页面

## 支付宝支付的若干疑问
1. 为什么使用异步通知作为支付成功的依据，而不是同步通知？
    - 异步通知比同步通知安全  
      想象一下，前端接收到了支付宝的同步通知，然后前端通知后端，说“用户支付成功了”，然后后端更新数据库中用户的订单状态为已支付。这个过程中有两个问题：第一，前端如何判断这个通知是来自支付宝的；第二，所有发送给后端的通知，都是前端发出的吗，是否有可能是别人伪造的前端通知。
      其实第一个问题是可以做解决的，将支付宝发来的通知，发给后台，后台进行一定的签名验证，然后再发给支付宝，让支付宝再做一次校验，应该就能防止其伪造。但是这一路下来，时间太长了，用户等不起，任何一个时间点出错，则同步通知都会失败！而且，由前端发往后端的所有请求都是很容易伪造的，而且如果让前端解析支付宝通知，则前端必须保留一份支付宝的密钥，但是由于前端所有代码都是可以反编译的，所以相当于公开源码了，通讯的密钥就公开了，这是极端危险的。
    - 异步通知比同步通知稳定  
      假如说，用户支付成功之后立即关闭支付宝app，或者南瓜姑娘app，或者WEB支付的页面，再或者用户网络不好、断网了，根本就没有进入同步通知这个步骤，怎么办？
      答案是没有任何办法，用户的任何行为和所处的环境条件，我们APP都不能做干涉，于是我们就接收不到支付宝的同步通知了。如果以同步通知为依据，则很可能后台无法记录本次支付记录。
    - 异步通知比同步通知多了很多修复bug的机会  
      同步通知只有一次，支付宝APP返回给南瓜姑娘APP，或者直接返回生成的WEB页面，如果在处理这个同步通知的时候出错，则永远没有再次处理的机会。但是异步通知则不会，如果异步通知处理出错，他会在25个小时内连续向南瓜姑娘服务器发送8次请求，直到服务器返回正确的值为止。
    - 异步通知与同步通知的时间间隔本身没有那么大  
      基本不会出现同步通知结束了好久，异步通知才发出的情况。
2. 支付失败时，为什么一定要通知后端删除本次预支付记录？
    - 订单处理的业务逻辑中需要根据该订单是否已支付、是否正在支付，来切换订单状态。比如：订单15分钟未支付，则需要切换该订单为已支付状态。但是如果该订单用户正在支付（有预支付订单记录），后台尚未收到支付异步通知时，这时做15分钟超时的切换就是不对的；如果用户改用户支付失败，后台一直保存该订单的预支付记录，也是不对的。所以，应当在每次支付失败时，都要删除预支付记录。
    - 无用的支付记录，浪费存储空间，不利于数据的查询和业务处理。
3. 使用WEB支付，支付失败时，是否通知了后端删除本次预支付记录？后端怎样做的处理？
    WEB支付失败时，后台并没有做删除操作。后台有一个监控预支付订单状态的定时任务，如果指定的时间段内，没有支付成功，则删除本次预支付记录。

## 支付相关重要概念
1. 签约
    使用支付宝的任何接口，都需要在支付宝商户中提出申请，签约该接口：
    https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.MFFUhD&treeId=58&articleId=103542&docType=1

2. 配置公钥
    https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.ZDoP9G&treeId=58&articleId=103543&docType=1

3. 签名
    发往支付宝的请求和接收到的支付宝请求，都需要对参数进行根据算法拼接（私钥参与计算），计算sign值
    https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.3j6cib&treeId=59&articleId=103927&docType=1


## 支付宝相关文档资料
1. 支付宝文档中心
    https://doc.open.alipay.com/doc2/alipayDocIndex.htm

2. 支付宝APP支付（移动支付）文档及Demo下载
    https://doc.open.alipay.com/doc2/detail?treeId=59&articleId=103563&docType=1

3. 支付宝WEB支付（手机网站支付）文档及Demo下载
    https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.Dqxgok&treeId=60&articleId=103564&docType=1
